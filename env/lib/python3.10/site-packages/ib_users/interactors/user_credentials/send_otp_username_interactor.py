from ib_users.constants.otp_verification_constants import SendOTPThrough
from ib_users.interactors.exceptions.user_credentials_exceptions import \
    ContactDetailsNotPresentException
from ib_users.interactors.storages import UserAccountsStorage
from ib_users.interactors.storages.user_accounts_storage import \
    UserEmailAndPhoneNumberDTO
from ib_users.interactors.third_party.otp_service import OTPService
from ib_users.utils.interactors.login_interactors_common import \
    are_email_and_phone_number_not_empty, is_phone_number_not_empty
from ib_users.validators import UsernameValidator


class SendOTPUsernameInteractor:
    def __init__(self, storage: UserAccountsStorage, otp_service: OTPService):
        self.storage = storage
        self.otp_service = otp_service

    def send_otp_given_username(self, username: str):
        from ib_users.constants.otp_constants import OTPMessageFormatConstants
        UsernameValidator.validate(username)
        user_contact_details: UserEmailAndPhoneNumberDTO = \
            self.storage.get_user_details_to_send_otp_given_username(username)
        print('are_email_and_phone_number_not_empty: ',
              are_email_and_phone_number_not_empty(user_contact_details))
        if are_email_and_phone_number_not_empty(user_contact_details):
            self.otp_service.send_otp_to_user(
                user_contact_details.email,
                user_contact_details.phone_number,
                OTPMessageFormatConstants.FORMAT_TO_RESET_PASSWORD,
                OTPMessageFormatConstants.OTP_SUBJECT_TO_RESET_PASSWORD)
        elif user_contact_details.email:
            self.otp_service.send_otp_to_user_email(
                user_contact_details.user_id,
                user_contact_details.email,
                OTPMessageFormatConstants.FORMAT_TO_RESET_PASSWORD)
        elif is_phone_number_not_empty(user_contact_details.phone_number):
            self.otp_service.send_otp_to_user_phone_number(
                user_contact_details.phone_number,
                OTPMessageFormatConstants.FORMAT_TO_RESET_PASSWORD,
                send_otp_through=SendOTPThrough.SMS,
                call_template=None)
        else:
            raise ContactDetailsNotPresentException
